#!/bin/bash

# Agentive Starter Kit - First-Run Onboarding
# Launches rem with full context for new project setup

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
CLAUDE_AGENTS_DIR="$PROJECT_ROOT/.claude/agents"
PROJECT_NAME=$(basename "$PROJECT_ROOT")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Display welcome banner
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘                                                                â•‘${NC}"
echo -e "${CYAN}â•‘   ${GREEN}ðŸš€ Agentive Starter Kit - First-Run Onboarding${CYAN}              â•‘${NC}"
echo -e "${CYAN}â•‘                                                                â•‘${NC}"
echo -e "${CYAN}â•‘   ${NC}Welcome! This will configure your new agentive project.${CYAN}      â•‘${NC}"
echo -e "${CYAN}â•‘   ${NC}rem (your coordinator agent) will guide you through setup.${CYAN}   â•‘${NC}"
echo -e "${CYAN}â•‘                                                                â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Check if already configured
if [[ -f "$PROJECT_ROOT/.env" ]]; then
    echo -e "${YELLOW}Note: .env file already exists.${NC}"
    echo -e "If you want to re-run onboarding, remove .env first:"
    echo -e "  rm .env"
    echo
    read -p "Continue anyway? (y/N): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}Use ./agents/launch for regular agent access.${NC}"
        exit 0
    fi
fi

# Check for onboarding agent
ONBOARDING_AGENT="$CLAUDE_AGENTS_DIR/onboarding.md"
if [[ ! -f "$ONBOARDING_AGENT" ]]; then
    echo -e "${RED}Error: onboarding agent not found at $ONBOARDING_AGENT${NC}"
    exit 1
fi

# Read onboarding agent content
ONBOARDING_CONTENT=$(cat "$ONBOARDING_AGENT")

# Get model from onboarding.md frontmatter
ONBOARDING_MODEL=$(sed -n '/^---$/,/^---$/p' "$ONBOARDING_AGENT" | sed '1d;$d' | grep "^model:" | sed "s/^model:[[:space:]]*//" | tr -d '"')
ONBOARDING_MODEL="${ONBOARDING_MODEL:-claude-sonnet-4-20250514}"

# Create onboarding state file
ONBOARDING_STATE="$PROJECT_ROOT/.agent-context/ONBOARDING-STATE.md"
cat > "$ONBOARDING_STATE" << 'EOF'
# Onboarding State

**Status**: In Progress
**Started**: $(date +%Y-%m-%d)

## Checklist

- [ ] Phase 1: Project name configured
- [ ] Phase 2: Languages selected
- [ ] Phase 3: API keys configured
- [ ] Phase 4: Features selected
- [ ] Phase 5: Agents customized
- [ ] Phase 6: First task created

## Configuration

- Project Name: (pending)
- Languages: (pending)
- Task Prefix: (pending)
- Linear Integration: (pending)
- Serena MCP: (pending)

---
*This file tracks onboarding progress. Delete after completion.*
EOF

# Replace the date placeholder
sed -i '' "s/\$(date +%Y-%m-%d)/$(date +%Y-%m-%d)/" "$ONBOARDING_STATE" 2>/dev/null || \
    sed -i "s/\$(date +%Y-%m-%d)/$(date +%Y-%m-%d)/" "$ONBOARDING_STATE"

echo -e "${GREEN}Project:${NC} $PROJECT_NAME"
echo -e "${GREEN}Agent:${NC} onboarding (setup specialist)"
echo -e "${GREEN}Model:${NC} $ONBOARDING_MODEL"
echo

# Build first-run context
FIRST_RUN_CONTEXT="
**FIRST-RUN ONBOARDING ACTIVE**

Project Context:
- Directory: $PROJECT_NAME
- Location: $PROJECT_ROOT
- Status: No .env file (unconfigured)
- Onboarding state: $ONBOARDING_STATE

Begin the interactive onboarding flow immediately. Start with Phase 1 (Welcome).
"

echo -e "${BLUE}Launching onboarding agent...${NC}"
echo

# Change to project directory
cd "$PROJECT_ROOT"

# Launch Claude with onboarding agent + first-run context
exec claude --model "$ONBOARDING_MODEL" --append-system-prompt "$ONBOARDING_CONTENT" "$FIRST_RUN_CONTEXT"
